---
layout: post
title: iOS14 Widget å¼€å‘ 101
date: 2020-11-27 22:11 +0800
---

* TOC
{:toc}
![image-20201124185813421](https://tva1.sinaimg.cn/large/0081Kckwly1gl0gq300xuj30ju0f5dpj.jpg)

æˆ‘ä»¬ç›´æ¥ä»åˆ›å»º Widget Extension å¼€å§‹ã€‚

# åˆ›å»º Widget Extension

Widget æ˜¯ä¸€ä¸ª App Extensionï¼Œå’Œä¸» App æœ¬è´¨ä¸Šæ˜¯ä¸¤ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥åç»­æˆ‘ä»¬éœ€è¦è§£å†³ä¸€äº›åŸºç¡€è®¾æ–½çš„é—®é¢˜ã€‚ä¸è¿‡åœ¨å®Œæˆåˆ›å»ºä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šé¢ä¸´æ˜¯å¦éœ€è¦å‹¾é€‰ã€ŒInclude Configuration Intentã€çš„é—®é¢˜ã€‚

![image-20201125155525486](https://tva1.sinaimg.cn/large/0081Kckwly1gl3jnj9ltbj30ee07pwf0.jpg)

é‚£ä¹ˆï¼ŒConfiguration Intent æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ 

## Configuration Intent 

Widget æ”¯æŒç”¨æˆ·åœ¨ä¸æ‰“å¼€ App çš„æƒ…å†µä¸‹ï¼Œå¯¹ Widget è¿›è¡Œä¸€äº›é…ç½®ã€‚æ¯”å¦‚å¤©æ°”åº”ç”¨çš„ Widgetï¼Œå¯ä»¥è®¾ç½®å½“å‰çš„ä½ç½®ä¿¡æ¯ã€‚

<img src="https://tva1.sinaimg.cn/large/0081Kckwly1gl3jmnjgznj30qu0rzwfx.jpg" alt="0081Kckwly1gl1ha3bz0xj30u01hcnf9" style="zoom: 33%;" />

Configuration Intent å³æ˜¯ç”¨äºå®šä¹‰ç”¨æˆ·åœ¨ç¼–è¾‘ Widget æ—¶çœ‹åˆ°çš„é…ç½®é¡µé¢ï¼Œå¦‚æœå‹¾é€‰çš„è¯ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå’Œ Widget åŒåçš„ SiriKit Intent Definition Fileï¼Œå…¶ä½¿ç”¨å’Œ Siri Intent File åŸºæœ¬ç±»ä¼¼ï¼Œåœ¨é…ç½® Widget çš„éƒ¨åˆ†ä¼šå†è¯¦ç»†è¯´æ˜ã€‚

# è®¤è¯† Widget

æ¥ä¸‹æ¥å…ˆçœ‹ä¸‹æˆ‘ä»¬åˆ›å»ºäº† Widget Extension å Xcode ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„ä»£ç ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç»“æ„ï¼Œ

- Widget
- View
- TimelineEntry
- TimelineProvider
- PreviewProvider

PreviewProvider æ˜¯ç”¨äºåœ¨ Canvas ä¸Šå®æ—¶é¢„è§ˆã€‚å¦å¤– Widgetã€View å’Œ Timeline Provider ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼Œ



<img src="https://useyourloaf.com/blog/widgetkit-for-ios-getting-started/widget.png" alt="Widget Overview - Configuration, Timeline Provider and Entry View" style="zoom:67%;" />



å¯ä»¥å¯¹ç…§ Xcode å¸®æˆ‘ä»¬ç”Ÿæˆçš„ Widget çš„å®ç°ä¸€èµ·æ¥çœ‹ï¼Œ

```swiftui
@main
struct ProgressWidget: Widget {
    let kind: String = "ProgressWidget"

    var body: some WidgetConfiguration {
        IntentConfiguration(kind: kind, 
                            intent: ConfigurationIntent.self, 
                            provider: Provider()) { entry in
            ProgressWidgetEntryView(entry: entry)
        }
        .configurationDisplayName("My Widget")
        .description("This is an example widget.")
    }
}
```

Widget æ˜¯ä¸€ä¸ªåè®®ï¼Œå®ƒåªå®šä¹‰äº†ä¸€ä¸ªå˜é‡ `body`ï¼Œ `body` æ˜¯éµå®ˆåè®® WidgetConfiguration çš„å˜é‡ï¼Œå¯ä»¥æœ‰ä¸¤ç§ç±»å‹ï¼ˆå¯¹åº”å‰é¢æåˆ°çš„ï¼Œåœ¨åˆ›å»º Widget Extension æ—¶æ˜¯å¦å‹¾é€‰ã€ŒInclude Configuration Intentã€ï¼‰ï¼Œ

- [`StaticConfiguration`](https://developer.apple.com/documentation/widgetkit/staticconfiguration)ï¼Œå¯¹äºæ²¡æœ‰ç”¨æˆ·å¯é…ç½®å±æ€§çš„ Widgetï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ— éœ€é…ç½®ï¼Œå±•ç¤ºçš„å†…å®¹åªå’Œç”¨æˆ·ä¿¡æ¯æœ‰å…³ç³»ã€‚æ¯”å¦‚ Keep çš„ medium å¤§å°çš„ Widgetã€‚
- [`IntentConfiguration`](https://developer.apple.com/documentation/widgetkit/intentconfiguration)ï¼Œç”¨äºæ”¯æŒç”¨æˆ·é…ç½®çš„ Widgetã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒIntentConfiguration æ˜¯é€šè¿‡é…ç½®è€Œéä»£ç ç¼–å†™æ¥å®ç°ï¼ŒXcode ä¼šæ ¹æ®é…ç½®ç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚

ä¸ºäº†åˆå§‹åŒ– Configurationï¼Œè¿˜éœ€è¦æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼ˆä»¥ IntentConfiguration ä¸ºä¾‹ï¼‰ï¼Œ

```swift
/// Creates a configuration for a widget by using a custom intent
    /// definition to provide user-configurable options.
    /// - Parameters:
    ///   - kind: A unique string that you choose.
    ///   - intent: A custom intent definition containing user-editable
    ///     parameters.
    ///   - provider: An object that determines the timing of updates
    ///     to the widget's views.
    ///   - content: A view that renders the widget.
    public init<Provider>(kind: String, 
                          intent: Intent.Type, 
                          provider: Provider, 
                          content: @escaping (Provider.Entry) -> Content) where Intent == Provider.Intent, Provider : IntentTimelineProvider
```

- kind*ï¼Œæ˜¯æˆ‘ä»¬ä¸ºæ¯ä¸ª Widget å®šä¹‰çš„å”¯ä¸€æ ‡è¯†ï¼Œåç»­å½“æˆ‘ä»¬æƒ³è¦åˆ·æ–°æŸä¸ª Widget æ—¶ï¼Œè¯¥å€¼å¯ä»¥å®šä½åˆ°å”¯ä¸€çš„ Widget
- intent*ï¼Œå¯¹åº”çš„æ˜¯ Siri Intent File ä¸­å®šä¹‰çš„ Intentï¼ŒStaticConfiguration æ²¡æœ‰è¯¥å‚æ•°
- providerï¼ŒIntentTimelineProviderï¼Œç”¨äºå‘ WidgetKit æä¾› Timelineï¼Œè¿™ä¸ªç¨åç»†è¯´
- contentï¼Œè¿”å›ä¸€ä¸ª SwiftUI Viewï¼Œå³å¯¹åº” Widget çš„è§†å›¾éƒ¨åˆ†ï¼ˆè¿™æ˜¯ä¸€ä¸ª `() -> Content ` ç±»å‹ï¼Œå…³äºè¿™ä¸ªçš„æ›´å¤šè®²è§£ï¼Œå¯ä»¥å‚è€ƒå–µç¥çš„ [ã€ŠSwiftUI çš„ä¸€äº›åˆæ­¥æ¢ç´¢ (ä¸€ï¼‰ã€‹](https://onevcat.com/2019/06/swift-ui-firstlook/)ï¼‰

# ç†è§£ Timeline

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1805b82ae3514e6697d2a24f400dc420~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20201126110726464" style="zoom: 25%;" />

ä¸ App ä¸åŒçš„æ˜¯ï¼ŒWidget çš„å†…å®¹å¹¶ä¸æ˜¯å®æ—¶æ¸²æŸ“çš„ï¼Œè€Œæ˜¯æ ¹æ® Timeline å±•ç¤ºçš„ä¸€ç»„é™æ€è§†å›¾ã€‚WidgetKit é€šè¿‡è°ƒç”¨ TimelineProvider çš„ `getTimeline` æ–¹æ³•æ¥è·å– Timeline å¹¶å±•ç¤ºã€‚

```swift
func getTimeline(for configuration: ConfigurationIntent, in context: Context, completion: @escaping (Timeline<Entry>) -> ()) {
        var entries: [SimpleEntry] = []

        // Generate a timeline consisting of five entries an hour apart, starting from the current date.
        let currentDate = Date()
        for hourOffset in 0 ..< 5 {
            let entryDate = Calendar.current.date(byAdding: .hour, value: hourOffset, to: currentDate)!
            let entry = SimpleEntry(date: entryDate, configuration: configuration)
            entries.append(entry)
        }

        let timeline = Timeline(entries: entries, policy: .atEnd)
        completion(timeline)
    }
```

Timeline ç”±å¤šä¸ªæ—¶é—´è½´æ¡ç›® `TimelineEntry` ä»¥åŠä¸€ä¸ªåˆ·æ–°ç­–ç•¥ `ReloadPolicy`  ç»„æˆã€‚

-  `TimelineEntry` å¿…é¡»åŒ…å«ä¸€ä¸ª `date` çš„æ—¶é—´å¯¹è±¡ï¼Œç”¨ä»¥å‘ŠçŸ¥ WidgetKit åœ¨ä½•æ—¶ä½¿ç”¨æ­¤å¯¹è±¡æ¥åˆ›å»º Widget çš„è§†å›¾ã€‚

-  `ReloadPolicy` å†³å®š WidgetKit ä½•æ—¶è¯·æ±‚åç»­çš„ Timelineã€‚åœ¨ç”Ÿæˆæ–°çš„ Timeline ä¹‹å‰ï¼ŒWidgetKit ä¼šä¸€ç›´ä½¿ç”¨ä¸Šä¸€æ¬¡ç”Ÿæˆçš„ Timeline æ¥å±•ç¤ºæ•°æ®ã€‚

æ—¢ç„¶çŸ¥æ™“äº† Widget æ˜¯ç”± Timeline æ„æˆçš„ä¸€ç»„é™æ€è§†å›¾ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ·æ–°å†…å®¹å‘¢ï¼Ÿ

## Widget åˆ·æ–°æ–¹æ³•

Widget çš„åˆ·æ–°æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼Œ

1. System reloads
2. App-driven reloads

### System reloads

ç”±ç³»ç»Ÿå‘èµ·çš„ Timeline åˆ·æ–°ã€‚ç³»ç»Ÿå†³å®šæ¯ä¸ªä¸åŒçš„ Timeline åˆ·æ–°çš„é¢‘æ¬¡ã€‚é«˜é¢‘ä½¿ç”¨çš„ Widget å¯ä»¥è·å¾—æ›´å¤šçš„åˆ·æ–°é¢‘æ¬¡ã€‚åˆ·æ–°ç­–ç•¥å¯¹åº”åˆ›å»º Timeline æ—¶æŒ‡å®šçš„ Reload Policyã€‚

Reload Policy æœ‰ä»¥ä¸‹ä¸‰ç§ï¼Œ

- `atEnd`: æ˜¯æŒ‡åœ¨å½“å‰ Timeline çš„æ‰€æœ‰ entry æ˜¾ç¤ºå®Œæ¯•ååˆ·æ–°
- `atAfter`: æ˜¯æŒ‡æŒ‡å®šçš„ä¸‹æ¬¡åˆ·æ–°çš„æ—¶é—´ï¼Œç³»ç»Ÿä¼šåœ¨è¿™ä¸ªæ—¶é—´å¯¹ Timeline è¿›è¡Œåˆ·æ–°
- `never`ï¼šæ˜¯æŒ‡ä»¥åä¸éœ€è¦åˆ·æ–°äº†ã€‚æœ€åä¸€ä¸ª entry å±•ç¤ºå®Œæ¯•ä¹‹å Widget å°±ä¼šä¸€ç›´ä¿æŒé‚£ä¸ª entry çš„æ˜¾ç¤ºå†…å®¹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦é‡æ–°åˆ·æ–°éœ€è¦ App é‡æ–°å‘ŠçŸ¥ Widget

### App-driven reloads

- å½“åº”ç”¨åœ¨å‰å°è¿è¡Œçš„æ—¶å€™ï¼ŒApp å¯ä»¥ç›´æ¥ä½¿ç”¨ WidgetCenter çš„ API æ¥ Reload Timeline

- å½“åº”ç”¨å¤„äºåå°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åå°æ¨é€ï¼ˆBackground Notificationï¼‰æ¥ Reload Timeline

```swift
func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -> Void) {
        
    if response.actionIdentifier == "actionIdentifier" {        
				WidgetCenter.shared.reloadAllTimelines()
     		// WidgetCenter.shared.reloadTimelines(ofKind: "KindOfWidget")
    }

    completionHandler()
}
```

# ç»˜åˆ¶ UI

Widget å¿…é¡»ä½¿ç”¨ SwiftUI è¿›è¡Œå¼€å‘ï¼ŒåŒæ—¶ç”±äº Widget å±•ç¤ºåœ¨ä¸»å±å¹•ä¸Šï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ SwiftUI æ§ä»¶éƒ½æ”¯æŒï¼Œé€šè¿‡ [`UIViewRepresentable`](https://developer.apple.com/documentation/swiftui/uiviewrepresentable) åŒ…è£…çš„æ§ä»¶éƒ½ä¸æ”¯æŒï¼Œæ¯”å¦‚ SwiftUI çš„ ProgressView æ§ä»¶ã€‚å¯ä»¥æ”¯æŒçš„æ§ä»¶åˆ—è¡¨å¯ä»¥å‚è€ƒ [SwiftUI Views](https://developer.apple.com/documentation/widgetkit/swiftui-views) ã€‚

é™¤æ­¤å¦å¤–ï¼ŒWidget ä¸æ”¯æŒæ»‘åŠ¨äº¤äº’ï¼Œä¹Ÿä¸æ”¯æŒå±•ç¤ºè§†å±å’ŒåŠ¨å›¾ã€‚

## å¿«é€Ÿå…¥é—¨ SwiftUI

ä¸ºäº†æ¨å¹¿ SwiftUI è‹¹æœå‡ºäº†ä¸€ä¸ªå¾ˆæ£’çš„äº’åŠ¨æ•™ç¨‹ [ã€ŠSwiftUI Tutorialsã€‹](https://developer.apple.com/tutorials/swiftui/) æ¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå…¥é—¨ã€‚å¯¹äº Widget å¼€å‘ï¼Œå¯ä»¥å…ˆå…³æ³¨å¦‚ä½•ä½¿ç”¨ SwiftUI çš„ UI ç»„ä»¶ã€æ ·å¼è®¾ç½®ã€å¸ƒå±€å’Œäº¤äº’è¿™å‡ éƒ¨åˆ†å†…å®¹ã€‚

> UPDATE 2020.12.30: è‹¹æœä»Šå¹´è¿˜æ¨å‡ºäº†[æ–°çš„ SwiftUI æ•™ç¨‹](https://developer.apple.com/tutorials/app-dev-training)ï¼Œä»¥å¼€å‘ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ App ä½œä¸ºä¸»è¦å†…å®¹ã€‚

# è·å–æ•°æ®

Widget ä¸»è¦æœ‰ä¸¤ç§è·å–æ•°æ®çš„æ–¹å¼ï¼Œ

- é€šè¿‡ App Group ä¸ä¸» App å…±äº«æ•°æ®
- é€šè¿‡ç½‘ç»œè¯·æ±‚è·å–æ•°æ®

## App Group

å› ä¸º App å’Œ App Extension æ˜¯ä¸èƒ½ç›´æ¥é€šè®¯çš„ï¼Œæ‰€ä»¥éœ€è¦å…±äº«ä¿¡æ¯æ—¶ï¼Œéœ€è¦ä½¿ç”¨ App Groups æ¥è¿›è¡Œé€šè®¯ã€‚App Groups æœ‰ä¸¤ç§å…±äº«æ•°æ®çš„æ–¹å¼ï¼Œåˆ†åˆ«é€šè¿‡`UserDefaults`å’Œ`FileManager`ã€‚UserDefaults å£°æ˜ä»¥ App Group ID ä¸º suiteName çš„å®ä¾‹å³å¯ï¼Œä½¿ç”¨ FileManager åˆ™å¯ä»¥é€šè¿‡è°ƒç”¨ `containerURLForSecurityApplicationGroupIdentifier` æ–¹æ³•ã€‚

```swift
#if KEEPBETA
static let kGroupId = "group.com.kp.keepbeta.widget"
#else
static let kGroupId = "group.com.gotokeep.keep.widget"
#endif

let sharedStore = UserDefaults(suiteName: KEPWidgetContentLoader.kGroupId)
```

## ç½‘ç»œè¯·æ±‚

Widget Extension æ”¯æŒè¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œå¯ä»¥åœ¨å– snapshot æˆ–è€… timeline çš„ä»£ç†æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨ URLSessionï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ App ä¸­çš„ç½‘ç»œæ¡†æ¶ï¼Œé‚£ä¹ˆéœ€è¦ç½‘ç»œæ¡†æ¶æ”¯æŒ Widget Targetã€‚

# äº¤äº’

Widget å’Œ App äº¤äº’æœ‰ä¸¤ç§æ–¹å¼ï¼Œ

1. Widget ç‰¹æœ‰çš„ widgetURL APIï¼Œä¸€èˆ¬ small ä½¿ç”¨
2. SwiftUI Link APIï¼Œä¸€èˆ¬ç”¨åœ¨ medium å’Œ large ä¸Šï¼Œå¯æ·»åŠ åˆ° SwiftUI View ä¸Š

è¿™ä¸¤ç§æ–¹å¼çš„æœ¬è´¨éƒ½æ˜¯ URL Schemesï¼Œè°ƒç”¨ååœ¨ App çš„ `application:openURL:sourceApplication:annotation: ` æ–¹æ³•ä¸­å¤„ç†å³å¯ã€‚

# åŠ¨æ€é…ç½®

å‰é¢å·²ç»æåˆ°è¿‡ IntentConfiguration å’Œ StaticConfiguration çš„åŒºåˆ«ï¼Œä¸ºäº†ä½¿ Widget å¯é…ç½®ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œ

1. åˆ›å»º Intent Definition Fileï¼ŒWidget çš„å¯é…ç½®çš„å‚æ•°åˆ—è¡¨æ˜¯ä½¿ç”¨ Intents è¿›è¡Œé…ç½®çš„ã€‚Intents æ˜¯ Apple åœ¨ WWDC 2016 å¼•å…¥çš„æ¦‚å¿µï¼Œå‚è§ [Introducing SiriKit](https://developer.apple.com/videos/play/wwdc2016/217/) å’Œ [Introduction to Siri Shortcuts](https://developer.apple.com/videos/play/wwdc2018/211)
2. WidgetConfiguration çš„ Provider éœ€è¦å¯¹åº”ä½¿ç”¨ [`IntentTimelineProvider`](https://developer.apple.com/documentation/widgetkit/intenttimelineprovider)ã€‚å…¶ API ä¸ TimelineProvider çš„åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å¢åŠ äº† configuration çš„å‚æ•°ï¼Œç”¨äºè·å–ç”¨æˆ·çš„é€‰æ‹©
3. å¦‚æœå¯ç¼–è¾‘çš„é€‰é¡¹æ˜¯åŠ¨æ€çš„ï¼Œæ¯”å¦‚å¤©æ°”åº”ç”¨ä¸­ï¼Œå¯ä»¥åŠ¨æ€åœ°åŠ è½½åŸå¸‚åˆ—è¡¨ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å®ç° Intent Extension

IntentDefinition æ–‡ä»¶

<img src="https://images.xiaozhuanlan.com/photo/2020/71753251e0d0d32871d9950fda6f762d.png" alt="img" style="zoom: 33%;" />

## å‚æ•°ç±»å‹

Widget æ”¯æŒé…ç½®ä»æ•´å‹ã€å­—ç¬¦ä¸²ç­‰åŸºç¡€ç±»å‹åˆ°æ—¥æœŸã€URL ç­‰é«˜çº§ç±»å‹çš„å‚æ•°ï¼ŒåŒæ—¶æ”¯æŒè‡ªå®šä¹‰å‚æ•°ç±»å‹å’Œæšä¸¾ç±»å‹ã€‚ç‰¹å®šçš„ç±»å‹è¿˜æœ‰è¿‘ä¸€æ­¥çš„è‡ªå®šä¹‰é€‰é¡¹æ¥å®šåˆ¶è¾“å…¥ UIã€‚

æ¯”å¦‚ï¼ŒDecimal ç±»å‹å¯ä»¥é€‰æ‹©é‡‡ç”¨è¾“å…¥æ¡†ï¼ˆNumber Fieldï¼‰è¾“å…¥æˆ–è€…æ˜¯æ»‘å—ï¼ˆSliderï¼‰è¾“å…¥ï¼ŒåŒæ—¶å¯ä»¥å®šåˆ¶è¾“å…¥çš„ä¸Šä¸‹é™ï¼›Duration ç±»å‹å¯ä»¥å®šåˆ¶è¾“å…¥å€¼çš„å•ä½ä¸ºç§’ã€åˆ†æˆ–è€…æ—¶ï¼›Date Components å¯ä»¥æŒ‡å®šè¾“å…¥æ—¥æœŸè¿˜æ˜¯æ—¶é—´ï¼ŒæŒ‡å®šæ—¥æœŸçš„æ ¼å¼ç­‰ç­‰ã€‚

<img src="https://images.xiaozhuanlan.com/photo/2020/37c34e66d013ec3ee291e03c9b9fd771.png" alt="img" style="zoom: 33%;" />

è‡ªå®šä¹‰æšä¸¾æˆ–è€…å‚æ•°ç±»å‹

<img src="https://images.xiaozhuanlan.com/photo/2020/de8c6493a0eacbeb543d11e5b97c797d.png" alt="img" style="zoom: 50%;" />

ä¸åŒå‚æ•°ä¹‹é—´å¯ä»¥è®¾ç½®ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚æ—¥å† App çš„ Up Next Widgetï¼Œä»…åœ¨ Mirror Calendar App é€‰é¡¹æ²¡æœ‰è¢«é€‰ä¸­æ—¶ï¼Œæ‰ä¼šæ˜¾ç¤º Calendars é…ç½®é¡¹ã€‚

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f93dff2da96647e0aa7be7abddaf09ed~tplv-k3u1fbpfcp-zoom-1.image" alt="IntentDefinitionParametersControl1" style="zoom: 50%;" />

åœ¨ Intent å®šä¹‰æ–‡ä»¶ä¸­ï¼Œå°†æŸä¸€ä¸ªå‚æ•° Aï¼Œè®¾ç½®ä¸ºå¦ä¸€ä¸ªå‚æ•° B çš„ `Parent Parameter` ï¼Œè¿™æ ·ï¼Œå‚æ•° B çš„æ˜¾ç¤ºä¸å¦å°±å–å†³äºå‚æ•° A çš„å€¼ã€‚

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30fa67be0be04686b7d9c978483c3d74~tplv-k3u1fbpfcp-zoom-1.image" alt="IntentDefinitionParametersControl2" style="zoom: 33%;" />



> æ³¨æ„äº‹é¡¹

1. å¢åŠ äº† intent æˆ–è€… parameterï¼Œå¯èƒ½éœ€è¦ rebuild æˆ–è€… reboot Xcode ğŸ™‚ï¸ æ‰èƒ½ä¿ƒä½¿å…¶åœ¨ç”Ÿæˆçš„æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”çš„å˜é‡ã€‚
2. æ–°å¢åŠ çš„ Intent æ–‡ä»¶ï¼Œæ³¨æ„ target éœ€è¦å‹¾é€‰ä¸Šä¸» appï¼Œå¦åˆ™ä¼šå‡ºç°ç¼–è¾‘å°ç»„ä»¶æ—¶åŠ è½½ã€ŒUnable to loadã€çš„æƒ…å†µ [Xcode 12 beta 3 WidgetKit Unable tâ€¦ | Apple Developer Forums](https://developer.apple.com/forums/thread/655245?login=true)

é‚£ä¹ˆï¼Œå¦‚ä½•è§£æç”¨æˆ·é€‰æ‹©çš„å‚æ•°å‘¢ï¼Ÿä»¥ Enum å‚æ•°ç±»å‹ä¸ºä¾‹ï¼Œ

```swift
func activityDataType(for configuration: ViewActivityTypeIntent) -> KEPActivityDataType {
    switch configuration.activityType {
    case .training:
        return .training
    case .yoga:
        return .yoga
    case .running:
        return .running
    case .hiking:
        return .hiking
    default:
        return .unknown
    }
}
```

# å…¶å®ƒ

## Intelligence

Siri donationï¼Œè€ƒè™‘ Intent ä¸­å‚æ•°çš„ç»„åˆï¼Œåœ¨æŸäº›ç”¨æˆ·è¡Œä¸ºä¸‹ï¼Œdonate  ä¸€ä¸ª intent

![123a6d956866f11c85bf59b4a5aeb69a](https://tva1.sinaimg.cn/large/0081Kckwly1gl3g49hmj8j32b00u0nki.jpg)

## é¢œè‰²å’Œå­—ä½“

å¦‚æœéœ€è¦ä½¿ç”¨ä¸»é¡¹ç›®ä¸­çš„èµ„æºï¼Œéœ€è¦å°†èµ„æºçš„ target å‹¾ä¸Š Widget extensionã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯å­—ä½“ï¼Œè¿˜éœ€è¦åœ¨ Widget çš„ `info.plist` ä¸­å¢åŠ è¯¥å­—ä½“çš„æè¿°ã€‚

![9BF33B4B-7640-4BEA-9BC5-39EDF615ECB3](https://tva1.sinaimg.cn/large/0081Kckwly1gl3jlhh35qj30nm06pq47.jpg)

## å¤šä¸ª Widget

æœ‰ä¸¤ç§æ–¹å¼ï¼Œ

1. åŒä¸€ä¸ª Widgetï¼Œé€šè¿‡ `@Environment(\.widgetFamily)` è·å– Widget çš„å°ºå¯¸ï¼Œå¹¶é€‚é… UI

```swift
	struct EmojiRangerWidgetEntryView: View {
    var entry: Provider.Entry
    
    @Environment(\.widgetFamily) var family

    @ViewBuilder
    var body: some View {
        switch family {
        case .systemSmall:
            ZStack {
                AvatarView(entry.character)
                    .widgetURL(entry.character.url)
                    .foregroundColor(.white)
            }
            .background(Color.gameBackground)
        default:
            ZStack {
                HStack(alignment: .top) {
                    AvatarView(entry.character)
                        .foregroundColor(.white)
                    Text(entry.character.bio)
                        .padding()
                        .foregroundColor(.white)
                }
                .padding()
                .widgetURL(entry.character.url)
            }
            .background(Color.gameBackground)
        }
    }
}
```

2. ç¼–å†™ä¸åŒçš„ Widgetï¼Œé€šè¿‡ `@WidgetBundleBuilder` ç»„åˆåœ¨ä¸€èµ·ã€‚ä½¿ç”¨ `@main` æ ‡è®°

```swift
@main
struct EmojiRangerBundle: WidgetBundle {
    @WidgetBundleBuilder
    var body: some Widget {
        EmojiRangerWidget()
        LeaderboardWidget()
    }
}
```